* F283DS2E
*
* DOS PART 2
*
Getfil LDA #$15
 STA ERSTAT,X
 LDA #$FF
 STA DRVENO,X
 CLR FLNAME,X
 CLR FLEXTN,X
 JSR LD0D0
 LDA #8
 STA MAXFN
 BSR LD07C
 BCS LD078
 BNE NOTFS
 BSR LD07C
 BCS LD078
 BNE NOTFS
 CMPX CMDPTR
 BEQ SETERR
 BSR LD07C
 BLS SETERR

NOTFS LDX CMDPTR
 TST FLNAME,X
 BEQ SETERR
 TST DRVENO,X
 BPL LD075
 TST SYSFLG USE SYSTEM DRIVE FLAG
 BEQ LD070
 LDA SYSDRV
 BRA LD073

LD070 LDA WRKDRV

LD073 STA DRVENO,X

LD075 CLR SYSFLG USE SYSTEM DRIVE FLAG

LD078 LDX CMDPTR
 RTS

LD07C BSR Nxtch
 BCS SETERR
 CMPA #$39
 BHI ALPCHR
 LDX CMDPTR
 TST DRVENO,X
 BPL SETERR
 ANDA #3
 STA DRVENO,X
 JSR Nxtch
 BCC SETERR

LD094 CMPA #$2E
 CLC
 RTS

ALPCHR LDB MAXFN
 BMI SETERR
 PSHS B
 SUBB #5
 STB MAXFN
 PULS B

LD0A7 CMPA ULCFLG UPPPER-LOWER CASE MAP FLAG
 BCS LD0AE
 SUBA #$20

LD0AE STA FLNAME,X
 LEAX 1,X
 DECB
 JSR Nxtch
 BCC LD0C0
 CMPA #$2D
 BEQ LD0C0
 CMPA #$5F
 BNE LD0C6

LD0C0 TSTB
 BNE LD0A7

SETERR SEC
 RTS

LD0C6 TSTB
 BEQ LD094
 CLR FLNAME,X
 LEAX 1,X
 DECB
 BRA LD0C6

LD0D0 STX CMDPTR
 LDX LINPTR

LD0D6 LDA 0,X
 CMPA #$20
 BNE LD0E0
 LEAX 1,X
 BRA LD0D6

LD0E0 STX LINPTR
 LDX CMDPTR
 RTS

Setext PSHS X,Y
 LDB FLEXTN,X
 BNE LD10B
 LEAY <DEFEXT,PCR

LD0F0 CMPA #$0F


 BHI LD10B
 LDB #3
 MUL
 LEAY D,Y
 LDB #3

LD0FB LDA 0,Y+
 CMPA ULCFLG UPPPER-LOWER CASE MAP FLAG
 BCS LD104
 SUBA #$20

LD104 STA FLEXTN,X
 LEAX 1,X
 DECB
 BNE LD0FB

LD10B PULS X,Y,PC

DEFEXT FCC "bin"
 FCC "txt"
 FCC "cmd"
 FCC "bas"
 FCC "sys"
 FCC "bak"
 FCC "scr"
 FCC "dat"
 FCC "bac"
 FCC "dir"
 FCC "prt"
 FCC "out"
 FCC "rel"
 FCC "rfi"
 FCC "dev"
 FCC "arc"

Gethex JSR LD229

LD140 JSR Nxtch
 BCS LD167
 BSR LD16D
 BCS LD161
 PSHS B
 LDB #4

LD14D ASL LDROFF+1
 ROL LDROFF
 DECB
 BNE LD14D
 PULS B
 ADDA LDROFF+1
 STA LDROFF+1
 INCB
 BRA LD140

LD161 JSR Nxtch
 BCC LD161
 RTS

LD167 LDX LDROFF

LD16A CLC
 RTS

LD16D CMPA #$5F
 BLS LD173
 SUBA #$20

LD173 SUBA #$47
 BPL LD183
 ADDA #6
 BPL LD17F
 ADDA #7
 BPL LD183

LD17F ADDA #$0A
 BPL LD16A

LD183 SEC
 RTS

Indec JSR LD229

LD189 JSR Nxtch
 BCS LD167
 CMPA #$39
 BHI LD161
 ANDA #$0F
 PSHS B
 PSHS A
 LDD LDROFF
 ASLB
 ROLA
 ASLB
 ROLA
 ADDD LDROFF
 ASLB
 ROLA
 ADDB 0,S+
 ADCA #0
 STD LDROFF
 PULS B
 INCB
 BRA LD189

Load CLR XFERFG

LD1B3 BSR LD1F2
 CMPA #2
 BEQ LDADDR
 CMPA #$16
 BNE LD1B3
 BSR LD1F2
 STA XFERAD
 BSR LD1F2
 STA XFERAD+1
 LDA #1
 STA XFERFG
 BRA LD1B3

LDADDR BSR LD1F2
 TFR A,B
 BSR LD1F2
 EXG A,B
 ADDD LDROFF
 STD FLADDR
 BSR LD1F2
 TFR A,B
 TSTA
 BEQ LD1B3

LD1E3 BSR LD1F2
 LDX FLADDR
 STA 0,X+
 STX FLADDR
 DECB
 BNE LD1E3
 BRA LD1B3

LD1F2 LDX #SYSFCB SYSTEM FCB ADDRESS
 JSR FMS FILE MANAGER EXEC CALL
 BEQ LD20B
 LDA ERSTAT,X
 CMPA #8
 BNE LD20E
 LEAS 2,S
 LDA #4
 STA FNCODE,X
 JSR FMS FILE MANAGER EXEC CALL
 BNE LD215

LD20B CLC
 RTS

LD20E STA ERRTYP
 CMPA #4
 BEQ LD287

LD215 BSR Rpterr
 JMP LCDDE

GETCAL LDA #0
 BSR LD253
 BCS LD22F
 BSR LD229
 INC LCC4C
 BSR Load
 BRA GETCAL

LD229 CLRA
 CLRB
 STD LDROFF
 RTS

LD22F LDB LCC4C
 LBEQ LCDD3
 JMP WARMS

OPCFIL LDA #2
 BSR LD25F
 BSR LD229
 JSR Load
 LDB XFERFG
 BEQ LD24B
 JMP [XFERAD]

LD24B LDX #NO_TFR
 LDA #$81
 JMP LCDD8

LD253 PSHS A
 LDX #SYSFCB SYSTEM FCB ADDRESS
 JSR Getfil
 PULS A
 BCS LD279

LD25F LDX #SYSFCB SYSTEM FCB ADDRESS
 JSR Setext
 LDX #SYSFCB SYSTEM FCB ADDRESS
 LDA #1
 STA FNCODE,X
 BSR LD1F2
 LBCS CMNOTF
 LDA #$FF
 STA SPCOMP,X
 RTS

LD279 LDA LSTTRM
 CMPA #$0D
 BEQ LD287
 CMPA TTYEOL
 LBNE LCDD3

LD287 SEC
 RTS

Rpterr PSHS X,Y
 LDA ERSTAT,X
 STA ERRTYP
 BEQ LD2F6
 JSR Rstrio
 LDY ERRVEC
 BNE LD2A4
 CMPA #$10
 BEQ LD2F8
 JSR CNTFND
 BEQ LD2F6
 LDY #ERRORS

LD2A4 LDX #SYSFCB SYSTEM FCB ADDRESS
 TST ACSTAT,X
 BEQ LD2B4
 LDA #4
 STA FNCODE,X
 JSR FMS FILE MANAGER EXEC CALL
 BNE LD2E2

LD2B4 LDX #LC838
 LDB #$0B
 BSR LD329
 LDX #SYSFCB SYSTEM FCB ADDRESS
 LDA SYSDRV
 STA DRVENO,X
 LDA #1
 STA FNCODE,X
 JSR FMS FILE MANAGER EXEC CALL
 BNE LD2E2
 LDA ERRTYP
 DECA
 ASRA
 ASRA
 INCA
 CLR 32,X
 STA CURECN+1,X
 LDA #$15
 STA FNCODE,X
 JSR FMS FILE MANAGER EXEC CALL
 BEQ LD300

LD2E2 LDX #DSKERR
 JSR Pstrng
 LDX CMDPTR
 LDA ERRTYP
 STA 1,X
 CLR 0,X
 CLRB
 JSR Outdec

LD2F6 PULS X,Y,PC

LD2F8 LDX #NREADY
 JSR Pstrng
 BRA LD2F6

LD300 JSR Pcrlf
 LDX #SYSFCB SYSTEM FCB ADDRESS
 LDA ERRTYP
 DECA
 ANDA #3
 LDB #$3F
 MUL
 ADDB #4
 STB DATIND,X

LD314 JSR FMS FILE MANAGER EXEC CALL
 BNE LD2E2
 JSR Putchr
 CMPA #$0D
 BNE LD314
 LDA #4
 STA FNCODE,X
 JSR FMS FILE MANAGER EXEC CALL
 BRA LD2F6

LD329 PSHS X,Y
 JMP LD0FB


Docmnd PULS A,B
 STD DOCRTN
 STS LCC45
 CLR ERRTYP
 INC CMDFLG
 JMP LCDB2

USRCAL CLR CMDFLG
 LDS LCC45
 LDB ERRTYP
 JMP [DOCRTN]

Addbx ABX
 RTS

MONCAL TST PRCFLG ACTIVE SPOOLING PROCESS FLAG
 BNE LD35F
 JMP [MONITR]

LD35F LDX #SYSFCB SYSTEM FCB ADDRESS
 LDA #$1B
 STA ERSTAT,X
 JSR Rpterr
 JMP Warms

