* F283FM1C
*
* FMS EQUATES. FMS PART 1
*
*---------------------------------
*   FILE CONTROL BLOCK OFFSETS
*---------------------------------

*  FNCODE   BYTE   0     FUNCTION CODE
*  ERSTAT   BYTE   1     ERROR STATUS BYTE
*  ACSTAT   BYTE   2     ACTIVITY STATUS
*  DRVENO   BYTE   3     DRIVE NUMBER
*  FLNAME   BYTE   4     FILE NAME
*  FLEXTN   BYTE   12    EXTENSION
*  FLATTR   BYTE   15    FILE ATTRIBUTES
*  FLSTRT   BYTE   17    STARTING DISK ADDRESS OF THE FILE
*  FLEND    BYTE   19    ENDING DISK ADDRESS OF THE FILE
*  FLSIZE   BYTE   21    FILE SIZE
*  FLSMAP   BYTE   23    FILE SECTOR MAP INDICATOR
*  RESVRD   BYTE   24    RESERVED BYTE USED IN V2.8.3
*  FLDATE   BYTE   25    FILE CREATION DATE
*  FLYEAR   BYTE   27    FILE CREATION DATE (YEAR)
*  FCBPTR   BYTE   28    FCB LIST POINTER
*  CURPOS   BYTE   30    CURRENT POSITION
*  CURECN   BYTE   32    CURRENT RECORD NUMBER
*  DATIND   BYTE   34    DATA INDEX
*  RNDIND   BYTE   35    RANDOM INDEX
*  NWKBUF   BYTE   36    NAME WORK BUFFER
*  CDIRAD   BYTE   47    CURRENT DIRECTORY ADDRESS
*  FSTDIR   BYTE   50    FIRST DELETED DIRECTORY POINTER
*  SCRBYT   BYTE   53    SCRATCH BYTES
*  SPCOMP   BYTE   59    SPACE COMPRESSION FLAG
*  SECBUF   BYTE   64    SECTOR BUFFER

*---------------------------------
*---------------------------------

 ORG $D400 FILE MANAGEMENT SYSTEM
*
FMSINT JMP Fmsint FILE MANAGEMENT SYSTEM INITIALISE

FMSCLS JMP Fmscls CLOSE UP ALL FILES ENTRY

FMS JMP Fms FILE MANAGER EXEC CALL


* SYSTEM INFORMATION RECORD IN MEMORY
*
BASFCB RMB 2 FCB BASE POINTER
CURFCB RMB 2 CURRENT FCB ADDRESS
LD40D RMB 2
LD40F RMB 2
RETRYC RMB 1 RETRY COUNT PER RESTORE
RSTORC RMB 1 RESTORE COUNT MAX
DIRTRK RMB 1 TRK START ADDR OF DIRECTORY
DIRSEC RMB 1 SEC START ADDR OF DIRECTORY
LD415 RMB 2
LD417 RMB 1
LD418 RMB 2
LD41A RMB 1
T_STBL RMB 2 PNTR TO FREE TRK/SEC TABLE
NFT_S0 RMB 2 NEXT FREE TRK/SEC DRIVE 0
EFT_S0 RMB 2 END OF FREE TRK/SEC DRIVE 0
FRSPC0 RMB 2 FREE SPACE COUNT DRIVE 0
NFT_S1 RMB 2 NEXT FREE TRK/SEC DRIVE 1
EFT_S1 RMB 2 END OF FREE TRK/SEC DRIVE 1
FRSPC1 RMB 2 FREE SPACE COUNT DRIVE 1
NFT_S2 RMB 2 NEXT FREE TRK/SEC DRIVE 2
EFT_S2 RMB 2 END OF FREE TRK/SEC DRIVE 2
FRSPC2 RMB 2 FREE SPACE COUNT DRIVE 2
NFT_S3 RMB 2 NEXT FREE TRK/SEC DRIVE 3
EFT_S3 RMB 2 END OF FREE TRK/SEC DRIVE 3
FRSPC3 RMB 2 FREE SPACE COUNT DRIVE 3

VRFYFG FCB $FF FMS VERIFY FLAG

SURTAB FCB $00,$00,$00,$00 FMS SURNAME TABLE

Fmsint JSR DDCOLD
 LDX #BASFCB FILE CONTROL BLOCK BASE
 LDB #$0A
 BSR CLEARX
 LDX #0005
 STX DIRTRK
 STX LD415
 CLR LD41A

CLEAR LDX #T_STBL
 LDB #$1A

CLEARX CLR 0,X+
 DECB
 BNE CLEARX
 JMP LC70C

Fmscls JSR LC709

LD460 LDX BASFCB FILE CONTROL BLOCK BASE
 BEQ CLEAR
 LEAX -28,X
 STX CURFCB
 PSHS Y
 JSR CLFILE
 PULS Y
 BCC LD460
 LDX CURFCB
 CLR ACSTAT,X
 JSR LC70C
 LDB #$FF
 RTS

Fms TST PRCFLG ACTIVE SPOOLING PROCESS FLAG
 BEQ LD487
 JSR LC709

LD487 PSHS B,Y
 STX CURFCB
 CLR ERSTAT,X
 LDB FNCODE,X
 BNE IDOPTN
 LDB ACSTAT,X
 BEQ ER018
 CMPB #2
 BEQ FMSWRT
 JSR LD5BC

FINISH LDX CURFCB
 BCS ERSET
 TST PRCFLG ACTIVE SPOOLING PROCESS FLAG
 BNE FAILUR
 CLRB
 PULS B,Y
 RTS

FMSWRT JSR LD6D7
 BRA FINISH

ER018 LDB #$12
 BRA ERSET

IDOPTN CMPB #$16
 BLS VALFNC
 LDB #1
 BRA ERSET

VALFNC DECB
 ASLB
 LDX #FNCTBL
 JSR [B,X]
 LDX CURFCB
 BCC FAILUR

ERSET STB ERSTAT,X

FAILUR JSR LC70C
 TST ERSTAT,X
 PULS B,Y
 RTS

FNCTBL FDB ROPEN
 FDB WOPEN
 FDB UOPEN
 FDB CLFILE
 FDB RWFILE
 FDB DOPEN
 FDB GETIR
 FDB PUTIR
 FDB RSSECT
 FDB WSSECT
 FDB ZZZZC
 FDB DLFILE
 FDB RNFILE
 FDB ZZZZA
 FDB NSSECT
 FDB OSIREC
 FDB GRSECT
 FDB PRSECT
 FDB ZZZZB
 FDB FNDRVE
 FDB POSNRN
 FDB BUREC

FSTAT BSR FINDP
 BNE FFREE
 LDB #2
 SEC
 RTS

FFREE STD 0,X
 LDX 0,X
 CLR FNCODE,X
 CLR ERSTAT,X
 RTS

RSTAT BSR FINDP
 BEQ FUSE
 LDB #$0D
 SEC
 RTS

FUSE LDD [0,X]
 STD 0,X
 CLC
 RTS

FINDP LDD CURFCB
 ADDD #$001C
 LDX #BASFCB FILE CONTROL BLOCK BASE

CHEKXY LDY 0,X
 BNE CHECKP
 ANDCC #$FB
 RTS

CHECKP CMPD 0,X
 BNE NEXTP
 RTS

NEXTP LDX 0,X
 BRA CHEKXY

LD53B LDX CURFCB
 CLRA
 CLRB
 BSR LD544
 LDB #$2F

LD544 STA FLSTRT,X
 LEAX 1,X
 DECB
 BNE LD544
 RTS

LD54D LDX CURFCB
 LDB #$0B

LD552 LDA FLNAME,X
 STA NWKBUF,X
 LEAX 1,X
 DECB
 BNE LD552
 RTS

LD55D LDX CURFCB
 LDB #$0B

LD562 LDA FLNAME,X
 ORA #$20
 PSHS A
 LDA NWKBUF,X
 ORA #$20
 CMPA 0,S+
 BNE LD576
 LEAX 1,X
 DECB
 BNE LD562

LD576 RTS

GRSECT LDX CURFCB
 LDB ACSTAT,X
 LSRB
 BCC ERR18
 LDB RNDIND,X
 JMP LD608

LD585 LDX CURFCB
 LDB DATIND,X
 INC DATIND,X
 ABX
 STA SECBUF,X
 INCB
 BNE LD5B4
 SEC
 RTS

PRSECT LDX CURFCB
 LDB ACSTAT,X
 ANDB #3
 CMPB #3
 BNE ERR18
 ORB #$80
 STB ACSTAT,X
 LDB FLATTR,X
 BITB #$80
 BNE ERR11
 LDB RNDIND,X
 ABX
 STA SECBUF,X

LD5B4 CLC
 RTS

ERR11 LDB #$0B
 SEC
 RTS

LD5BC LDA SPCOMP,X
 BMI LD5FD
 BEQ LD5CA
 DEC SPCOMP,X
 LDA #$20
 BRA LD5E7

LD5CA BSR LD5FD
 BCS LD5E9
 CMPA #$18
 BHI LD5E7
 BEQ LD5CA
 CMPA #9
 BNE LD5E4
 BSR LD5FD
 BCS LD5E9
 LDX CURFCB
 STA SPCOMP,X
 BRA LD5BC

LD5E4 TSTA
 BEQ LD5CA

LD5E7 CLC

LD5E9 RTS

RWFILE JSR LDAC8
 BCS ERR18
 BITA #1
 BEQ ERR18
 STA FNCODE,X
 JMP LD9A9

ERR18 LDB #$12
 SEC
 RTS

LD5FD LDX CURFCB
 LDB DATIND,X
 BEQ LD60F
 INC DATIND,X

LD608 ABX
 LDA SECBUF,X
 CLC
 RTS

LD60F BSR LD614
 BCC LD5FD
 RTS

LD614 LDX CURFCB
 LDD SECBUF,X
 INC CURECN+1,X
 BNE LD622
 INC CURECN,X

LD622 CMPD #$0000
 BEQ ERR08

LD628 STD CURPOS,X
 PSHS A
 LDA #4
 STA DATIND,X
 PULS A
 BSR RSSECT
 BCC LD648
 BITB #$80
 BEQ ERR09
 LDB #$10
 BRA ERRNN

ERR09 LDB #9
 BRA ERRNN

ERR08 LDB #8

ERRNN SEC

LD648 RTS

RSSECT BSR LD670
 LDX CURFCB
 JSR DSELCT
 BCS LD665

LD653 BSR LD666
 JSR DREAD
 BNE LD65D
 CLC
 RTS

LD65D PSHS B
 BSR LD678
 PULS B
 BCC LD653

LD665 RTS

LD666 LDX CURFCB
 LDD CURPOS,X
 LEAX SECBUF,X
 RTS

LD670 CLRA
 STA RETRYC
 STA RSTORC
 RTS

LD678 BITB #$10
 BNE LD68D
 BITB #$80
 BNE LD6A4
 LDB RETRYC
 INCB
 CMPB #5
 BEQ LD68D
 STB RETRYC
 BRA ZZZZA

LD68D CLR RETRYC
 LDB RSTORC
 INCB
 CMPB #7
 BEQ LD6A4
 STB RSTORC
 LDX CURFCB
 JSR DRESTR

ZZZZA CLC
 RTS

LD6A4 SEC
 RTS

WSSECT BSR LD670
 LDX CURFCB
 JSR DSELCT
 BCS LD6D1

LD6B1 LDX CURFCB
 BSR LD666
 JSR DWRITE
 BNE LD6C5
 LDA VRFYFG FMS VERIFY FLAG
 BEQ LD6F7
 JSR DVERFY
 BEQ LD6F7

LD6C5 BITB #$40
 BNE LD6D4
 PSHS B
 BSR LD678
 PULS B
 BCC LD6B1

LD6D1 RTS
 LDB #$20

LD6D4 SEC
 RTS

LD6D7 LDX CURFCB
 LDB SPCOMP,X
 BMI LD71C
 CMPA #$20
 BNE LD6F2
 INCB
 STB SPCOMP,X
 CMPB #$7F
 BNE LD6F7
 BRA LD6FA

LD6ED BSR LD6FA
 BCC LD6D7
 RTS

LD6F2 TSTB
 BEQ LD71C
 BRA LD6ED

LD6F7 CLC
 RTS

LD6FA PSHS A
 CMPB #1
 BNE LD704
 LDA #$20
 BRA LD714

LD704 LDA #9
 BSR LD71C
 PULS A
 BCS LD71B
 PSHS A
 LDX CURFCB
 LDA SPCOMP,X

LD714 CLR SPCOMP,X
 BSR LD71C
 PULS A

LD71B RTS

LD71C LDX CURFCB
 LDB ACSTAT,X
 CMPB #2
 LBNE ERR18
 LDB DATIND,X
 CMPB #4
 BNE LD736
 PSHS A
 BSR LD753
 PULS A
 BCS LD745

LD736 JSR LD585
 BCC LD745
 LDB #4
 LDX CURFCB
 STB DATIND,X
 CLC

LD745 RTS

LD746 LDX CURFCB
 CLRA
 CLRB
 STD CURECN,X
 STD SECBUF+2,X
 BRA LD77A

LD753 LDB FLSTRT+1,X
 BNE LD77A
 LDB FLSMAP,X
 BEQ LD7A1
 CLR FLSMAP,X
 BSR LD7A1
 BCS LD78E
 BSR LD746
 BCS LD78E
 BSR LD746
 BCS LD78E
 LDX CURFCB
 LDB #2
 STB FLSMAP,X
 LDD FLSTRT,X
 JMP LDC99

LD77A BSR LD78A
 LDX CURFCB
 STD SECBUF,X
 JSR WSSECT
 BCC LD7A1
 JMP LDBD8

LD78A BSR LD78F
 LDD 0,X

LD78E RTS

LD78F LDX CURFCB
 LDB DRVENO,X
 LDA #6
 MUL
 LDX #NFT_S0
 ABX
 STX T_STBL
 TST 0,X
 RTS

LD7A1 BSR LD78A
 BNE LD7AA
 LDB #7

LD7A7 SEC
 RTS

LD7AA LDX CURFCB
 STD FLEND,X
 TST FLSTRT+1,X
 BNE LD7B8
 STD FLSTRT,X

LD7B8 INC FLSIZE+1,X
 BNE LD7C0
 INC FLSIZE,X

LD7C0 TST FLSMAP,X
 BEQ LD7D0
 JSR LDC5A
 BCS LD7A7
 LDX CURFCB
 LDD FLEND,X

LD7D0 JSR LD628
 BCS LD7A7
 LDX CURFCB
 LDD SECBUF,X
 PSHS A,B
 BSR LD78F
 PULS A,B
 STD 0,X
 BNE LD7EF
 CLR 2,X
 CLR 3,X
 CLR 4,X
 CLR 5,X
 BRA LD7F7

LD7EF LDY 4,X
 LEAY -1,Y
 STY 4,X

LD7F7 CLRA
 LDX CURFCB
 INC CURECN+1,X
 BNE LD803
 INC CURECN,X

LD803 CLRB

LD804 STA SECBUF,X
 LEAX 1,X
 DECB
 BNE LD804
 LDX CURFCB
 LDD 32,X
 STD SECBUF+2,X
 CLC
 RTS

OSIREC CLRB
 PSHS B
 LDB #3
 BRA LD82D
 LDX LD415
 STX DIRTRK

DOPEN LDB DIRTRK
 PSHS B
 LDB DIRSEC

LD82D LDX CURFCB
 STB SECBUF+1,X
 PULS B
 STB SECBUF,X
 CLR LD418
 CLRB
 STB DATIND,X
 RTS
