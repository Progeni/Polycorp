* F283INTE.TXT
*
* DOS INITIALISATION
*
* FILE CONTROL BLOCK DESCRIPTION EQUATES

FNCODE EQU 0 FUNCTION CODE
ERSTAT EQU 1 ERROR STATUS BYTE
ACSTAT EQU 2 ACTIVITY STATUS
DRVENO EQU 3 DRIVE NUMBER
FLNAME EQU 4 FILE NAME
FLEXTN EQU 12 EXTENSION
FLATTR EQU 15 FILE ATTRIBUTES
FLSTRT EQU 17 STARTING DISK ADDRESS OF THE FILE
FLEND EQU 19 ENDING DISK ADDRESS OF THE FILE
FLSIZE EQU 21 FILE SIZE
FLSMAP EQU 23 FILE SECTOR MAP INDICATOR
RESVRD EQU 24 RESERVED BYTE USED IN V2.8.3
FLDATE EQU 25 FILE CREATION DATE
FLYEAR EQU 27 FILE CREATION DATE (YEAR)
FCBPTR EQU 28 FCB LIST POINTER
CURPOS EQU 30 CURRENT POSITION
CURECN EQU 32 CURRENT RECORD NUMBER
DATIND EQU 34 DATA INDEX
RNDIND EQU 35 RANDOM INDEX
NWKBUF EQU 36 NAME WORK BUFFER
CDIRAD EQU 47 CURRENT DIRECTORY ADDRESS
FSTDIR EQU 50 FIRST DELETED DIRECTORY POINTER
SCRBYT EQU 53 SCRATCH BYTES
SPCOMP EQU 59 SPACE COMPRESSION FLAG
SECBUF EQU 64 SECTOR BUFFER


 ORG $C400

LC400 BRA LC407
VERSN FCC $82,".",$88,":",$83
 FCC " POLYFLEX Version "
 FCC $81,".",$81,":",$81

LC407 LDA #$39
 STA LD3FD
 LDD #WARMS
 STD ESCRET
 LDD TCHECK LOW-LEVEL TERM CHECK ADDRESS
 STD STAT_A
 LDD TOUTCH LOW-LEVEL TERM OUTPUT ADDRESS
 STD OUTCHA
 STD OUCH2A
 LDD TINCHE LOW-LEVEL TERM INPUT WITH ECHO
 STD INCHA
 STD INCH2A
 JSR [TINIT] LOW-LEVEL TERM INITIALISE
 JSR PCRLF
 LDX #FLEXTL
 JSR PSTRNG
 JSR PCRLF

LC43A LDA SYSMTH IF DATE VALID, DON'T ASK
 BEQ GETDAT = 0
 CMPA #12
 BHI GETDAT >= 12
 LDA SYSDAY
 BEQ GETDAT = 0
 CMPA #31
 BHI GETDAT > 31
 LDA SYSYR
 CMPA #87
 BLT GETDAT
 CMPA #97
 BLE GOTDAT
GETDAT LDD PROMPT
 PSHS A,B
 LDX #DATMES
 STX PROMPT
 JSR PSTRNG
 JSR INBUFF
 PULS A,B
 STD PROMPT
 LDY #SYSMTH
 BSR LC49D
 BLS LC43A
 BSR LC49D
 BLS LC43A
 BSR LC49D
 BLS LC43A
 JSR PCRLF
 LDD SYSMTH GET DAY AND MONTH
 EXG A,B
 STD SYSMTH STORE MONTH AND DAY
GOTDAT LDX #SYSFCB SYSTEM FCB ADDRESS
 JSR DCKRDY
 LDA #1
 STA FNCODE,X
 JSR FMS FILE MANAGER EXEC CALL
 BEQ LC47B
 LDA ERSTAT,X
 CMPA #4
 BNE LC4AF
 JMP WARMS

LC47B LDY #LINBUF
 STY LINPTR
 LDB #$80

LC485 JSR FMS FILE MANAGER EXEC CALL
 BNE LC4AF
 DECB
 BEQ LC4AF
 STA 0,Y+
 CMPA #$0D
 BNE LC485
 LDA #4
 STA FNCODE,X
 JSR FMS FILE MANAGER EXEC CALL
 JMP RENTER

LC49D JSR INDEC
 PSHS X
 BCS LC4AD
 LDA 0,Y
 TSTB
 BEQ LC4AB
 LDA 1,S

LC4AB STA 0,Y+

LC4AD PULS A,B,PC

LC4AF LDX #SUFMES
 JSR PSTRNG
 JMP WARMS

 ORG $C552 TO KEEP ORIGINAL POSITION

SUFMES FCC "Can't run STARTUP.",EOT

