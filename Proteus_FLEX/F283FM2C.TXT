* F283FM2C
*
* FMS PART 2
*
GETIR LDX CURFCB
 LDB DATIND,X
 BNE LD866
 JSR LD614
 BCS LD87E
 LDX CURFCB
 TST LD418
 BNE LD85B
 LDD #$0005
 STD LD418

LD85B LDA #$10
 STA DATIND,X
 LDD CURPOS,X
 STD CDIRAD,X

LD866 LDA DATIND,X
 STA CDIRAD+2,X
 LDB #$18

LD86E PSHS B,X
 JSR LD5FD
 PULS B,X
 STA 4,X
 LEAX 1,X
 DECB
 BNE LD86E
 CLC

LD87E RTS

PUTIR LDX CURFCB
 LDA CDIRAD+2,X
 STA DATIND,X
 LDB #$18

LD88A PSHS B,X
 LDA FLNAME,X
 JSR LD71C
 PULS B,X
 LEAX 1,X
 DECB
 BNE LD88A
 JMP WSSECT

LD89B LDX CURFCB
 LDA DRVENO,X
 STA RNDIND,X
 LDA LD417
 TST LD41A
 BNE LD8DC
 STA DRVENO,X
 LDX LD415
 STX DIRTRK

LD8B3 CMPX #0005
 BEQ LD8C4
 BSR LD8DC
 BLS LD8F3
 LDX LD418
 STX DIRTRK
 BRA LD8B3

LD8C4 LDX CURFCB
 LDA RNDIND,X
 STA DRVENO,X
 BPL LD8DC

LD8CE JSR FNDRVE
 BCS LD909
 BSR LD8DC
 BLS LD8F3
 JSR LDDC5
 BRA LD8CE

LD8DC LDX CURFCB
 CLR LD41A
 JSR LD54D
 JSR DOPEN

LD8E8 JSR GETIR
 BCC LD8F4
 CMPB #8
 BEQ LD909
 SEC

LD8F3 RTS

LD8F4 LDX CURFCB
 LDA FLNAME,X
 BEQ LD907
 BPL LD8FF
 BSR LD90E

LD8FF JSR LD55D
 BNE LD8E8
 CLC
 RTS

LD907 BSR LD90E

LD909 ANDCC #$FB
 CLC
 RTS

LD90E LDA FSTDIR+1,X
 BNE LD91F
 LDD CDIRAD,X
 STD FSTDIR,X
 LDA CDIRAD+2,X
 STA FSTDIR+2,X

LD91F RTS

LD920 JSR LD78F
 BNE LD93C
 BSR LD93F
 BCS LD93E
 LDB #6
 LDY CURFCB
 LDX T_STBL

LD932 LDA 93,Y
 LEAY 1,Y
 STA 0,X+
 DECB
 BNE LD932

LD93C CLC

LD93E RTS

LD93F JSR OSIREC
 JSR LD614
 BCS LD94F
 LDX CURFCB
 LDB #$10
 STB DATIND,X

LD94F RTS

LD950 JSR LD78F
 BSR LD93F
 BCS LD94F
 LDB #6
 LDY CURFCB
 LDX T_STBL

LD960 LDA 0,X+
 STA 93,Y
 LEAY 1,Y
 DECB
 BNE LD960
 JSR WSSECT
 BCC LD94F
 JMP LDBD8

ZZZZC LDX CURFCB
 LDA #2
 STA ACSTAT,X
 LDD CDIRAD,X
 STD CURPOS,X
 JSR RSSECT
 BCS LD98C
 JSR PUTIR
 BCC LD98E
 JMP LDBD8

LD98C LDB #$0A

LD98E RTS

ROPEN JSR FSTAT
 BCS REXIT
 JSR LD89B
 BCS REXIT
 BNE ERR04
 LDX CURFCB
 TST LD41A
 BEQ LD9A9
 LDA FLATTR,X
 BITA #$20
 BNE ERR17

LD9A9 JSR LDCD8
 BCS LD9D8
 LDD FLSTRT,X
 STD SECBUF,X
 JSR LDA8D
 LDB FLSMAP,X
 BEQ LD9CF

LD9BC PSHS B
 JSR LD614
 PULS B
 BCS REXIT
 DECB
 BNE LD9BC
 LDX CURFCB
 CLRB
 STB DATIND,X

LD9CF CLC

REXIT RTS

ERR17 LDB #$11
 BRA LD9D8

ERR04 LDB #4

LD9D8 PSHS B
 JSR RSTAT
 PULS B
 SEC
 RTS

WOPEN LDX CURFCB
 TST DRVENO,X
 BPL LD9F1
 JSR FNDRVE
 BCC LD9F1
 LDB #$10
 RTS

LD9F1 JSR FSTAT
 BCS LD9D8
 JSR LD53B
 JSR LD920
 BCS LD9D8
 JSR LD89B
 BCS LD9D8
 BNE LDA09
 LDB #3
 BRA LD9D8

LDA09 JSR LDCD8
 BCS LD9D8
 LDX CURFCB
 LDB #$0A

LDA13 CLR FLATTR,X
 LEAX 1,X
 DECB
 BNE LDA13
 LDX CURFCB
 LDD FSTDIR,X
 BEQ LDA56
 STD CDIRAD,X
 LDA FSTDIR+2,X
 STA CDIRAD+2,X
 LDD SYSMTH
 STD FLDATE,X
 LDA SYSYR
 STA FLYEAR,X
 LDA 3,X
 LDX #SURTAB FMS SURNAME TABLE
 LDA A,X
 LDX CURFCB
 STA RESVRD,X
 JSR LDDC5
 JSR ZZZZC
 BCS LD9D8
 BSR LDA8D
 LDA #4
 STA DATIND,X
 CLC
 RTS

LDA56 LDX CURFCB
 CLR FLSMAP,X
 INC FLSTRT+1,X
 LDD CDIRAD,X
 JSR LD628
 BCS LDA74
 JSR LD77A
 BCS LDA74
 JSR WSSECT
 BCC LDA77
 JSR LDBD8

LDA74 JMP LD9D8

LDA77 LDX CURFCB
 LDD CURPOS,X
 STD FSTDIR,X
 LDA #$10
 STA FSTDIR+2,X
 JSR LD950
 BCS LDA74
 JMP LDA09

LDA8D LDX CURFCB
 LDA FNCODE,X
 STA ACSTAT,X
 CLR FNCODE,X
 CLR SPCOMP,X
 CLRA
 STA DATIND,X
 RTS

NSSECT BSR LDAC8
 BCS LDAB0
 CLR FNCODE,X
 LSRA
 LBCS LD614
 LDB #4
 STB DATIND,X
 CLC

LDAB0 RTS

LDAB1 LDX CURFCB
 LDA ACSTAT,X
 CMPA #$83
 BNE LDAC5
 LDA #3
 STA ACSTAT,X

LDABE JSR WSSECT
 LBCS LDBD8

LDAC5 CLC
 RTS

LDAC8 BSR LDAB1
 BCS LDAD9
 LDX CURFCB
 LDA ACSTAT,X
 CMPA #3
 BLS LDAC5
 LDB #$12
 SEC

LDAD9 RTS

CLFILE BSR LDAC8
 BCS LDB0F
 CMPA #2
 BEQ LDAEA

LDAE2 LDX CURFCB
 CLR ACSTAT,X
 JMP RSTAT

LDAEA LDA FLSTRT+1,X
 BNE LDAF4
 JSR LDBBE
 BRA LDB0D

LDAF4 BSR LDABE
 BCS LDB0F
 LDX CURFCB
 TST FLSMAP,X
 BEQ LDB05
 JSR LDCAF
 BCS LDB0F

LDB05 JSR ZZZZC
 BCS LDB0F
 JSR LD950

LDB0D BCC LDAE2

LDB0F RTS

UOPEN JSR ROPEN
 BCS LDB3D
 JSR LD614
 BCS LDB3D
 LDA #3
 BRA LDB36

ZZZZB JSR ROPEN
 BCS LDB3D
 LDX CURFCB
 LDA FLATTR,X
 BITA #$80
 BNE ER011
 LDD FLEND,X
 JSR LD628
 BCS LDB3D
 LDA #2

LDB36 LDX CURFCB
 STA ACSTAT,X
 CLC

LDB3D RTS

ER011 LDB #$0B
 SEC
 RTS

RNFILE BSR LDB7A
 JSR LD89B
 BCS LDB74
 BEQ ERR03
 LDX CURFCB
 LDB #$0B

LDB51 LDA NWKBUF,X
 STA FLNAME,X
 LEAX 1,X
 DECB
 BNE LDB51
 BSR LDBAA
 BCS LDB74
 LDX CURFCB
 LDA FLATTR,X
 BITA #$80
 BNE ER011
 BITA #$60
 BNE ERR12
 BSR LDB7A
 BRA LDBC5

ERR03 LDB #3
 SEC

LDB74 RTS

ERR12 LDB #$0C
 SEC
 RTS

LDB7A LDX CURFCB
 LDA #$0B
 STA RETRYC

LDB82 LDA FLNAME,X
 LDB SCRBYT,X
 STA SCRBYT,X
 STB FLNAME,X
 LEAX 1,X
 DEC RETRYC
 BNE LDB82
 LDX CURFCB
 LDA 12,X
 BNE LDBA6
 LDB #3

LDB9C LDA 61,X
 STA 12,X
 LEAX 1,X
 DECB
 BNE LDB9C

LDBA6 LDX CURFCB
 RTS

LDBAA BSR LDB7A

LDBAC JSR LD89B
 BCS LDBB8
 BNE ER004
 LDX CURFCB
 CLC

LDBB8 RTS

ER004 LDB #4
 SEC
 RTS

LDBBE LDX CURFCB
 LDA #$FF
 STA FLNAME,X

LDBC5 JSR ZZZZC
 LDX CURFCB
 LDA #0
 STA ACSTAT,X
 RTS

LDBD0 STD SECBUF,X
 JSR WSSECT
 BCC LDBEC

LDBD8 BITB #$40
 BNE ERA11
 BITB #$80
 BEQ ERRSET
 LDB #$10
 BRA ERRSET

ERA11 LDB #$0B
 BRA ERRSET
 LDB #$0A

ERRSET SEC

LDBEC RTS

DLFILE JSR LD920
 BCS LDC50
 BSR LDBAC
 BCS LDC50
 LDX CURFCB
 LDA FLATTR,X
 BITA #$80
 BNE ERB11
 BITA #$60
 BNE ERA12
 JSR LD78F
 LDX T_STBL
 LDD 2,X
 BNE LDC1C
 LDX CURFCB
 LDD FLSTRT,X
 BEQ LDC48
 LDX T_STBL
 STD 0,X
 BRA LDC30

LDC1C LDX CURFCB
 JSR LD628
 BCS LDC50
 LDX CURFCB
 LDD FLSTRT,X
 BEQ LDC48
 BSR LDBD0
 BCS LDC50

LDC30 LDX CURFCB
 LDD FLEND,X
 LDX T_STBL
 STD 2,X
 LDX CURFCB
 LDD FLSIZE,X
 LDX T_STBL
 ADDD 4,X
 STD 4,X

LDC48 JSR LDBBE
 BCS LDC50
 JSR LD950

LDC50 RTS

ERB11 LDB #$0B
 BRA LDC57

ERA12 LDB #$0C

LDC57 SEC
 RTS

LDC5A LDD 30,X
 INCB
 CMPB 60,X
 BLS LDC66
 LDB #1
 INCA

LDC66 CMPD 19,X
 BNE LDC7A
 LDA 55,X
 CMPA #$FF
 BEQ LDC7A
 INCA
 STA 55,X
 CLC
 RTS

LDC7A BSR LDCAF
 BCS LDCAE
 LDX CURFCB
 LDA 58,X
 ADDA #3
 BNE LDC9E
 LDD CURPOS,X
 CMPD FLSTRT,X
 BEQ LDC96
 LDB #$17
 SEC
 RTS

LDC96 LDD SECBUF,X

LDC99 STD 56,X
 LDA #4

LDC9E STA 58,X
 LDD FLEND,X
 STD SCRBYT,X
 LDA #1
 STA 55,X
 CLC

LDCAE RTS

LDCAF LDD 56,X
 JSR LD628
 BCS LDCAE
 LDX CURFCB
 TFR X,Y
 LDB 58,X
 NOP
 ABX
 LDB #3

LDCC3 LDA 53,Y
 LEAY 1,Y
 STA SECBUF,X
 LEAX 1,X
 DECB
 BNE LDCC3
 JSR WSSECT
 BCC LDCAE
 JMP LDBD8

LDCD8 JSR OSIREC
 JSR LD614
 BCS LDD26
 LDX CURFCB
 CLRA
 CLRB
 STD CURECN,X
 LDA 103,X
 STA 60,X
 CLRB

LDCEF CLR SECBUF,X
 LEAX 1,X
 DECB
 BNE LDCEF
 LDX CURFCB
 CLC
 RTS

BUREC LDX CURFCB
 LDA FLSMAP,X
 BEQ ERA18
 LDD CURECN,X
 SUBD #$0001
 BPL LDD10
 JMP ERR24

LDD10 STD CURECN,X

POSNRN JSR LDAC8
 BCS LDD26
 RORA
 BCC ERA18
 CLR 0,X
 LDA 23,X
 BNE LDD27

ERA18 LDB #$12
 SEC

LDD26 RTS

LDD27 CLR RETRYC
 LDD FLSTRT,X
 LDY CURECN,X
 BEQ LDD9D
 JSR LDDB7
 BCS LDD26
 CLRA
 CLRB

LDD3A TST 2,X
 BEQ ERR24
 ADDB 2,X
 ADCA #0
 STX LD40F
 LDX CURFCB
 CMPD CURECN,X
 BCC LDD7A
 LDX LD40F
 LEAX 3,X
 PSHS A
 LDA RETRYC
 INCA
 STA RETRYC
 CMPA #$54
 BEQ LDD68
 CMPA #$A8
 PULS A
 BEQ ERR24
 BRA LDD3A

LDD68 PSHS B
 LDX CURFCB
 LDD SECBUF,X
 BSR LDDB7
 BCS ERR24
 PULS B
 PULS A
 BRA LDD3A

LDD7A SUBD 32,X
 LDX LD40F
 LDA 2,X
 PSHS B
 SUBA 0,S+
 DECA
 TFR A,B
 LDA 0,X
 ADDB 1,X
 LDX CURFCB
 BCS LDD97

LDD92 CMPB 60,X
 BLS LDD9D

LDD97 SUBB 60,X
 INCA
 BRA LDD92

LDD9D JSR LD628
 BCS LDDB6
 LDX CURFCB
 LDD SECBUF+2,X
 CMPD CURECN,X
 BEQ LDDC2
 LDB #$19
 BRA SETERA

ERR24 LDB #$18

SETERA SEC

LDDB6 RTS

LDDB7 JSR LD628
 BCS LDDC4
 LDX CURFCB
 LDB #$44
 ABX

LDDC2 CLC

LDDC4 RTS

LDDC5 LDX CURFCB
 LDB #$0B

LDDCA LDA NWKBUF,X
 STA FLNAME,X
 LEAX 1,X
 DECB
 BNE LDDCA
 RTS

FNDRVE LDX CURFCB
 LDA DRVENO,X
 INCA
 CMPA #4
 BCC ERR16
 STA DRVENO,X
 BNE LDDE8
 JSR DCKRDY
 BRA LDDEB

LDDE8 JSR DQCRDY

LDDEB BCS FNDRVE
 RTS

ERR16 LDB #$10
 SEC
 RTS

