CLFILE   LDX   FCBCADR
         LDA   ACTSTAT,X
         CMPA  #1
         BEQ   RCLOS         BRANCH IF OPEN FOR READ
         BSR   LDAB1         WRITE SECTOR IF IT HAS BEEN ALTERED
         BCS   LDAF8         BRANCH IF ERROR
         CMPA  #$02          FILE OPENED FOR WRITE?
         BEQ   OPNFW         YES THEN BRANCH
LDACB    LDX   FCBCADR
RCLOS    CLR   ACTSTAT,X     CLEAR ACTIVITY STATUS
         JMP   RSTAT         DELETED FROM FILE CHAIN

. FILE OPENED FOR WRITE,NEED TO UPDATE DIR
OPNFW    LDA   FLSTRT+1,X    FILE HAS ANY SECTOR
         BNE   HASECT        FILE HAS SECTOR
         JSR   RSTAT         DELETE FROM FREE CHAIN FIRST
         JSR   LDBA7         FILE HAS NO SECTOR,DELETE FROM DIR
         RTS

. FILE HAS AT LEAST 1 SECTOR
HASECT   BSR   LDAA7         WRITE LAST SECTOR
         BCS   LDAF8          BRANCH IF ERROR
         LDX   FCBCADR
         TST   FLSMAP,X       IS IT RANDOM FILE ?
         BEQ   LDAEE          BRANCH IF TRUE
         JSR   LDC98          UPDATE SECTOR MAP
         BCS   LDAF8          BRANCH IF ERROR
LDAEE    JSR   ZZZZC          UPDATE DIR ENTRY
         BCS   LDAF8          BRANCH IF ERROR
         JSR   RWSIR         REWRITE SYSTEM INFO REC
LDAF6    BCC   LDACB
LDAF8    PSHS  B,CC
         JSR   RSTAT         DELETE FILE FROM FREE CHAIN
         PULS  B,CC,PC


